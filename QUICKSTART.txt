â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘           ODF/Ceph Storage Audit Tools - QUICK START          â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ğŸš€ IMMEDIATE USE (First Time)
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. Verify prerequisites:
   oc get pod -n openshift-storage | grep rook-ceph-tools
   # If not found, create it:
   oc run -i -t rook-ceph-tools --image=registry.redhat.io/odf4/rook-ceph-rhel9-operator \
     --restart=Never --command -- bash
   
   # Verify Prometheus access (for enhanced metrics):
   oc whoami -t  # Should return a token
   oc get route thanos-querier -n openshift-monitoring  # Should show a route

2. Make scripts executable:
   chmod +x odf-*.sh

3. Run quick health check (1 minute):
   ./odf-quick-check.sh

4. Run full audit (3-5 minutes):
   ./odf-audit.sh
   # Note the output directory: /tmp/odf-audit-YYYYMMDD-HHMMSS
   # report.txt + report.json + data/* are created inside this directory

5. Review main report:
   less /tmp/odf-audit-*/report.txt

6. Analyze top consumers:
   ./odf-top-consumers.sh /tmp/odf-audit-*

7. Generate cleanup commands:
   ./odf-cleanup-generator.sh /tmp/odf-audit-*


ğŸ¯ COMMON SCENARIOS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ğŸ“Š Scenario 1: Daily Health Check
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
./odf-quick-check.sh
# Takes ~30 seconds
# Shows: cluster health, capacity, top issues


ğŸ” Scenario 2: Find What's Using Space
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
./odf-audit.sh
AUDIT_DIR=$(ls -td /tmp/odf-audit-* | head -1)
./odf-top-consumers.sh $AUDIT_DIR
less $AUDIT_DIR/top-consumers-report.txt


ğŸ§¹ Scenario 3: Find Orphaned Resources
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
./odf-audit.sh
AUDIT_DIR=$(ls -td /tmp/odf-audit-* | head -1)
# Review detailed orphan report with confidence levels:
less $AUDIT_DIR/potential-orphans.txt
# Or check JSON for automation:
jq '.orphans.rbd.high_confidence_orphans' $AUDIT_DIR/report.json
jq '.orphans.rgw.high_confidence_orphans' $AUDIT_DIR/report.json


ğŸ” Scenario 4: Interactive Investigation
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
./odf-inspector.sh
# Menu-driven interface
# Choose option to inspect specific resources


ğŸ“¦ Scenario 5: Check for Old Loki Buckets
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
./odf-audit.sh
AUDIT_DIR=$(ls -td /tmp/odf-audit-* | head -1)
grep -A 10 "Loki-Related Storage Check" $AUDIT_DIR/report.txt


âš ï¸  IMPORTANT SAFETY RULES
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

âŒ NEVER delete anything without:
   1. Verifying it's truly orphaned
   2. Checking if in use (watchers, pods)
   3. Taking backup if data is important
   4. Getting approval (production)

âœ… ALWAYS verify before deletion:
   # For RBD images:
   oc rsh -n openshift-storage rook-ceph-tools-xxx rbd status <pool>/<image>
   
   # For buckets:
   oc rsh -n openshift-storage rook-ceph-tools-xxx radosgw-admin bucket stats --bucket=<name>
   
   # For PVs:
   oc get pv <pv-name> -o yaml


ğŸ“ OUTPUT FILES EXPLAINED
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

After running odf-audit.sh, you'll find in /tmp/odf-audit-*/:

report.txt                  â† Main comprehensive report (READ THIS FIRST)
SUMMARY.txt                 â† Executive summary
report.json                 â† Machine-readable summary (cluster stats, datasets, orphan lists with confidence levels, data sources)
potential-orphans.txt       â† Detailed orphan candidates report categorized by confidence level (HIGH/MEDIUM/LOW) for manual review
data/                       â† Raw JSON captures:
                              â€¢ Prometheus metrics: prom-cluster-*.json, prom-pool-*.json, prom-mds-*.json
                              â€¢ Ceph commands: ceph-status.json, ceph-df.json
                              â€¢ Application data: rbd-images.json, rgw-buckets.json, pv.json, pvc.json, obc.json, cephfs-subvols.json
                              â€¢ OBC mappings: obc-buckets-spec.txt, obc-buckets-secrets.txt
top-consumers-report.txt    â† Space usage analysis (after running odf-top-consumers.sh)
cleanup-commands.sh         â† Generated deletion commands for high-confidence orphans (after running odf-cleanup-generator.sh)


ğŸ› ï¸  TROUBLESHOOTING
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Problem: "rook-ceph-tools pod not found"
Solution: 
  oc get pods -n openshift-storage | grep rook-ceph-tools
  # Create if missing - see prerequisite #1

Problem: "Cannot discover Prometheus endpoint"
Solution:
  oc get route thanos-querier -n openshift-monitoring
  oc whoami -t  # Should return a token
  # Ensure you have access to openshift-monitoring namespace
  # Scripts will fall back to ceph commands if Prometheus unavailable

Problem: "permission denied"
Solution:
  oc auth can-i create pods/exec -n openshift-storage
  oc auth can-i get routes -n openshift-monitoring
  # Request cluster-admin or storage-admin role

Problem: Scripts hang
Solution:
  # Check if rook-ceph-tools is responsive:
  oc rsh -n openshift-storage rook-ceph-tools-xxx ceph -s
  # If slow, may need to increase timeouts

Problem: jq/curl command not found
Solution:
  # Install required tools:
  yum install jq bc curl -y   # RHEL/CentOS
  apt install jq bc curl -y   # Ubuntu


ğŸ“Š INTERPRETING RESULTS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Storage Usage Thresholds:
  < 60%  : Healthy, normal operation
  60-75% : Monitor, plan capacity
  75-85% : Warning, plan expansion soon
  > 85%  : Critical, take action immediately

Orphaned Resources:
  "ORPHANED?: pool/image" - RBD image without matching PV
  "ORPHANED?: bucket-name" - Bucket without matching OBC
  
  Action: Verify manually before deletion!

Health Status:
  HEALTH_OK   : All good
  HEALTH_WARN : Review warnings, may need action
  HEALTH_ERR  : Immediate attention required


ğŸ”— NEXT STEPS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

1. Set up automated monitoring (see crontab-examples.txt)
2. Establish retention policy for audit reports
3. Define cleanup procedures with team
4. Document custom resources for future reference
5. Schedule regular capacity planning reviews


ğŸ“š DOCUMENTATION
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

Full documentation:  README-ODF-AUDIT.md
Cron examples:       crontab-examples.txt
Interactive tool:    ./odf-inspector.sh


ğŸ’¡ PRO TIPS
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

â€¢ Run quick-check daily, full audit weekly
â€¢ Keep audit reports for trend analysis
â€¢ Review orphaned resources quarterly
â€¢ Set up alerts at 75% capacity
â€¢ Document manual resources (pools, buckets)
â€¢ Test cleanup in dev before production
â€¢ Always verify resources are truly unused


â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

For detailed documentation, see: README-ODF-AUDIT.md
For interactive investigation: ./odf-inspector.sh
For questions: Check logs in audit output directory

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
